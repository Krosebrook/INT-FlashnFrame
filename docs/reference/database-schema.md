# Database Schema Reference

Flash-n-Frame uses PostgreSQL with Drizzle ORM for type-safe database interactions.

## Schema Location

`db/models/auth.ts` - All table definitions

## Tables

### users

Stores user account information for authentication.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `id` | `varchar` | PRIMARY KEY, default: `gen_random_uuid()` | Unique user identifier |
| `email` | `varchar` | UNIQUE | User email address |
| `password_hash` | `varchar` | nullable | Bcrypt-hashed password (null for OAuth-only users) |
| `first_name` | `varchar` | nullable | User's first name |
| `last_name` | `varchar` | nullable | User's last name |
| `profile_image_url` | `varchar` | nullable | URL to user's profile image |
| `email_verified` | `timestamp` | nullable | When email was verified (null = unverified) |
| `created_at` | `timestamp` | default: `now()` | Account creation timestamp |
| `updated_at` | `timestamp` | default: `now()` | Last update timestamp |

**Notes:**
- Users created via Replit Auth have `password_hash = null`
- Users created via email/password signup have a bcrypt hash (12 salt rounds)
- The `id` is a UUID generated by PostgreSQL

### sessions

Stores active user sessions. Managed by `connect-pg-simple`.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `sid` | `varchar` | PRIMARY KEY | Session identifier |
| `sess` | `jsonb` | NOT NULL | Serialized session data (user info, tokens) |
| `expire` | `timestamp` | NOT NULL, INDEXED | Session expiration time |

**Notes:**
- This table is mandatory for Replit Auth - do not drop it
- An index `IDX_session_expire` exists on the `expire` column for efficient cleanup
- Expired sessions are cleaned up automatically by `connect-pg-simple`

## Schema Management

### Pushing Schema Changes

```bash
npm run db:push
```

This uses `drizzle-kit push` to apply schema changes directly to the database. This is suitable for development and Replit deployments.

### TypeScript Types

Drizzle ORM generates TypeScript types from the schema:

```typescript
import { UpsertUser, User } from '../db/models/auth';

// UpsertUser - for INSERT operations (all fields optional except required ones)
// User - for SELECT operations (all fields present)
```

## Client-Side Storage (IndexedDB)

In addition to PostgreSQL, the app uses IndexedDB for client-side persistence:

| Store | Purpose | Data |
|-------|---------|------|
| History | Analysis history | Repo URLs, timestamps, results |
| Tasks | Task management | Task items, statuses |
| ProjectState | Current project | Active repo, file tree, graph data |

IndexedDB data is browser-local and not synced to the server.

## Related

- [ADR-001: Database Decision](../decisions/ADR-001-database.md)
- [Architecture Overview](../ARCHITECTURE.md)
